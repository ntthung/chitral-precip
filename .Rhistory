legend.box.margin = margin(),
legend.margin = margin(),
legend.key.width = unit(2, 'cm'),
legend.position = 'top')
p2 <- ggplot() +
stat_density(aes(y = Q, colour = 'Reconstruction', linetype = 'Reconstruction'),
recFinal[year %in% PSepAug$year], geom = 'line', bw = 60, size = 0.4) +
stat_density(aes(y = Qbc, colour = 'Bias-corrected', linetype = 'Bias-corrected'),
recFinal[year %in% PSepAug$year], geom = 'line', bw = 70, size = 0.4) +
stat_density(aes(y = Qa, colour = 'Observation', linetype = 'Observation'),
PSepAug, geom = 'line', bw = 70, size = 0.4) +
scale_colour_manual(
name = NULL,
values = c('Observation' = 'gray30',
'Reconstruction' = 'steelblue',
'Bias-corrected' = 'darkorange')) +
scale_linetype_manual(
name = NULL,
values = c('Observation' = 1,
'Reconstruction' = 1,
'Bias-corrected' = 2)) +
scale_x_continuous(guide = guide_prism_offset()) +
scale_y_continuous(
minor_breaks = seq(100, 850, 50),
breaks = seq(100, 850, 100),
limits = c(100, 850),
guide = guide_prism_offset_minor()) +
labs(y = NULL, x = 'Density', colour = NULL, tag = 'b)') +
theme(
axis.text.y = element_blank(),
legend.box.margin = margin(),
legend.margin = margin(),
legend.key.width = unit(2, 'cm'),
legend.position = 'top') +
theme(legend.position = 'top')
layout <- '
CCC
AAB
AAB
AAB
AAB
AAB
AAB
'
p1 + p2 + guide_area() +
plot_layout(design = layout, guides = 'collect')
# ggsave('figures/inst-period.png', width = 7, height = 4, dpi = 600)
p1 <- ggplot(recFinal[year %in% PSepAug$year]) +
geom_line(aes(year, Q, colour = 'Reconstruction', linetype = 'Reconstruction'), size = 0.4) +
geom_line(aes(year, Qbc, colour = 'Bias-corrected', linetype = 'Bias-corrected'), size = 0.4) +
geom_line(aes(year, Qa, colour = 'Observation', linetype = 'Observation'),
PSepAug, size = 0.4) +
scale_colour_manual(
name = NULL,
values = c('Observation' = 'gray30',
'Reconstruction' = 'steelblue',
'Bias-corrected' = 'darkorange')) +
scale_linetype_manual(
name = NULL,
values = c('Observation' = 1,
'Reconstruction' = 1,
'Bias-corrected' = 2)) +
scale_x_continuous(
minor_breaks = seq(1965, 2020, 5),
limits = c(1966, 2018),
guide = guide_prism_offset_minor()) +
scale_y_continuous(
minor_breaks = seq(100, 850, 50),
breaks = seq(100, 850, 100),
limits = c(100, 850),
guide = guide_prism_offset_minor()) +
labs(x = 'Year', y = 'Precipitation [mm]', tag = 'a)') +
theme(
plot.margin = margin(r = 10),
legend.box.margin = margin(),
legend.margin = margin(),
legend.key.width = unit(2, 'cm'),
legend.position = 'top')
p2 <- ggplot() +
stat_density(aes(y = Q, colour = 'Reconstruction', linetype = 'Reconstruction'),
recFinal[year %in% PSepAug$year], geom = 'line', bw = 60, size = 0.4) +
stat_density(aes(y = Qbc, colour = 'Bias-corrected', linetype = 'Bias-corrected'),
recFinal[year %in% PSepAug$year], geom = 'line', bw = 70, size = 0.4) +
stat_density(aes(y = Qa, colour = 'Observation', linetype = 'Observation'),
PSepAug, geom = 'line', bw = 70, size = 0.4) +
scale_colour_manual(
name = NULL,
values = c('Observation' = 'gray30',
'Reconstruction' = 'steelblue',
'Bias-corrected' = 'darkorange')) +
scale_linetype_manual(
name = NULL,
values = c('Observation' = 1,
'Reconstruction' = 1,
'Bias-corrected' = 2)) +
scale_x_continuous(guide = guide_prism_offset()) +
scale_y_continuous(
minor_breaks = seq(100, 850, 50),
breaks = seq(100, 850, 100),
limits = c(100, 850),
guide = guide_prism_offset_minor()) +
labs(y = NULL, x = 'Density', colour = NULL, tag = 'b)') +
theme(
axis.text.y = element_blank(),
legend.box.margin = margin(),
legend.margin = margin(),
legend.key.width = unit(2, 'cm'),
legend.position = 'top') +
theme(legend.position = 'top')
layout <- '
CCC
AAB
AAB
AAB
AAB
AAB
AAB
'
p1 + p2 + guide_area() +
plot_layout(design = layout, guides = 'collect')
# ggsave('figures/inst-period.png', width = 7, height = 4, dpi = 600)
ggplot(recFinal) +
geom_line(aes(year, Q, colour = 'Reconstruction')) +
geom_line(aes(year, lp20, colour = '20-year low-pass filter')) +
geom_line(aes(year, lp50, colour = '50-year low-pass filter'), size = 1) +
geom_hline(yintercept = mean(recFinal$Q), colour = 'firebrick') +
scale_colour_manual(
name = NULL,
values = c(
'Reconstruction' = 'grey',
'20-year low-pass filter' = 'black',
'50-year low-pass filter' = 'darkorange')) +
scale_x_continuous(breaks = seq(1500, 2000, 25), labels = skip_label(2)) +
scale_y_continuous(breaks = seq(200, 800, 50), labels = skip_label(2)) +
theme(
legend.key.width = unit(2, 'cm'),
legend.position = 'top') +
labs(x = 'Year', y = 'Precipitation [mm]')
ggplot(recFinal) +
geom_line(aes(year, Q, colour = 'Reconstruction', linetype = 'Reconstruction')) +
geom_line(aes(year, Qbc, colour = 'Bias corrected', linetype = 'Bias corrected')) +
geom_hline(yintercept = mean(recFinal$Q), colour = 'firebrick') +
scale_colour_manual(
name = NULL,
values = c('darkorange', 'black')) +
scale_linetype_manual(name = NULL, values = c(2, 1)) +
theme(
legend.key.width = unit(2, 'cm'),
legend.position = 'top') +
labs(x = 'Year', y = 'Precipitation [mm]')
recFinal[, rolMax := frollapply(Qbc, 50, max, align = 'right')]
recFinal[, rolMin := frollapply(Qbc, 50, min, align = 'right')]
recFinal[, rolMed := frollapply(Qbc, 50, median, align = 'right')]
recFinal[, period := fcase(
year %in% 1517:1767, 1,
default = 2)]
densCals <- recFinal[, {
d <- density(Qbc, cut = 0, bw = 45)
list(x = d$x, y = d$y / max(d$y) * 1.5)
}, by = period]
medians <- recFinal[, {
d <- density(Qbc, cut = 0, bw = 45)
m <- median(Qbc)
y <- approx(d$x, d$y, m)$y
list(x = m, y = y / max(d$y) * 1.5)
}, by = period]
recFinal[, dP := Qbc - mean(Qbc),
][, type := classify_events(dP)
][, dp10 := pass.filt(dP, 10)]
droughts <- get_timing(recFinal$dP, recFinal$type)[type == 'drought']
droughts[, ':='(yearStart = recFinal[start, year],
period = recFinal[start, period],
yearFinal = recFinal[final, year])]
worstDroughts <- droughts[order(peak)][1:3]
recFinal[, ks.test(.SD[period == 1, Qbc], .SD[period == 2, Qbc], exact = TRUE)]
recFinal[, rolMax := frollapply(Qbc, 50, max, align = 'right')]
recFinal[, rolMin := frollapply(Qbc, 50, min, align = 'right')]
recFinal[, rolMed := frollapply(Qbc, 50, median, align = 'right')]
recFinal[, period := fcase(
year %in% 1517:1767, 1,
default = 2)]
densCals <- recFinal[, {
d <- density(Qbc, cut = 0, bw = 45)
list(x = d$x, y = d$y / max(d$y) * 1.5)
}, by = period]
medians <- recFinal[, {
d <- density(Qbc, cut = 0, bw = 45)
m <- median(Qbc)
y <- approx(d$x, d$y, m)$y
list(x = m, y = y / max(d$y) * 1.5)
}, by = period]
recFinal[, dP := Qbc - mean(Qbc),
][, type := classify_events(dP)
][, dp10 := pass.filt(dP, 10)]
droughts <- get_timing(recFinal$dP, recFinal$type)[type == 'drought']
droughts[, ':='(yearStart = recFinal[start, year],
period = recFinal[start, period],
yearFinal = recFinal[final, year])]
worstDroughts <- droughts[order(peak)][1:3]
recFinal[!is.na(rolMax), tfpwmk(rolMax)] |> round(6)
recFinal[!is.na(rolMin), tfpwmk(rolMin)] |> round(6)
recFinal[!is.na(rolMed), tfpwmk(rolMed)] |> round(6)
p1 <- ggplot(recFinal) +
geom_line(aes(year, Qbc, color = 'Annual')) +
labs(x = NULL, y = 'P [mm]') +
geom_line(aes(year, rolMax, colour = '50-yr max'), na.rm = TRUE, size = 0.4) +
geom_line(aes(year, rolMin, colour = '50-yr min'), na.rm = TRUE, size = 0.4) +
geom_line(aes(year, rolMed, colour = '50-yr median'), na.rm = TRUE, size = 0.4) +
geom_smooth(aes(year, rolMax, colour = '50-yr max'), size = 0.6,
formula = 'y ~ x', method = 'lm', na.rm = TRUE, fill = NA) +
geom_smooth(aes(year, rolMin, colour = '50-yr min'), size = 0.6,
formula = 'y ~ x', method = 'lm', na.rm = TRUE, fill = NA) +
geom_smooth(aes(year, rolMed, colour = '50-yr median'), size= 0.6,
formula = 'y ~ x', method = 'lm', na.rm = TRUE, fill = NA) +
scale_x_continuous(
expand = c(0, 0),
minor_breaks = seq(1500, 2025, 25),
limits = c(1500, 2025),
guide = guide_prism_offset_minor()) +
scale_y_continuous(
minor_breaks = seq(200, 900, 50),
breaks = seq(200, 900, 100),
limits = c(200, 900),
labels = skip_label(2),
guide = guide_prism_offset_minor()) +
labs(x = NULL, y = 'Precipitation [mm]', colour = NULL, tag = 'a)') +
scale_color_manual(values = c(RColorBrewer::brewer.pal(3, 'Set2'), 'gray')) +
theme(
legend.key.width = unit(0.5, 'cm'),
legend.position = 'top')
p2 <- ggplot(densCals) +
geom_ribbon(aes(x, ymin = period, ymax = y + period, group = factor(period),
fill = factor(period)),
alpha = 0.5) +
geom_line(aes(x, y + period, group = factor(period))) +
geom_linerange(aes(x, ymin = period, ymax = period + y), medians, colour = 'firebrick') +
scale_fill_manual(
labels = c('1517-1717', '1718-2018'),
values = wesanderson::wes_palette('Royal1', 4)[c(1, 4)]) +
scale_x_continuous(
guide = guide_prism_offset_minor(),
breaks = seq(200, 900, 100),
minor_breaks = seq(200, 900, 20)) +
scale_y_continuous(
expand = c(0, 0),
breaks = c(1.5, 2.5),
labels = c('1517-1717', '            1718-2018')) +
labs(x = 'Precipitation [mm]', y = NULL, tag = 'b)') +
theme(
legend.position = 'none',
axis.line.y = element_blank(),
axis.text.y.left = element_text(angle = 90, hjust = 0.5),
axis.ticks.y = element_blank())
p3 <- ggplot(recFinal) +
geom_rect(
aes(xmin = yearStart, xmax = yearFinal, ymin = -Inf, ymax = Inf),
worstDroughts,
fill = 'magenta4', alpha = 0.1) +
geom_col(aes(year, dP, fill = dP)) +
scale_fill_distiller(
palette = 'BrBG', limits = abs_range(recFinal$dP),
guide = guide_none(),
direction = 1) +
scale_color_manual(values = 'black') +
scale_x_continuous(
expand = c(0, 0),
minor_breaks = seq(1500, 2025, 25),
limits = c(1500, 2025),
guide = guide_prism_offset_minor()) +
scale_y_continuous(
breaks = seq(-300, 400, 100),
minor_breaks = seq(-300, 400, 50),
guide = guide_prism_offset_minor()) +
labs(x = NULL, y = 'Precipitation anomaly [mm]', tag = 'c)') +
theme(
legend.position = 'top')
p4 <- ggplot(droughts) +
geom_point(aes(dur, peak, color = as.character(period)), alpha = 0.6) +
geom_text(
aes(dur, peak, label = paste(yearStart, yearFinal, sep = '-')),
worstDroughts,
size = 2, hjust = 0.8, nudge_y = -15) +
# scale_x_continuous(
#   breaks = seq(2, 20, 2),
#   guide = guide_prism_offset_minor()) +
# scale_y_continuous(
#   breaks = seq(-300, 0, 50),
#   limits = c(-275, -25),
#   guide = guide_prism_offset_minor()) +
scale_color_manual(
labels = c('1517-1717', '1718-2018'),
values = wesanderson::wes_palette('Royal1', 4)[c(1, 4)]) +
labs(x = 'Drought duration [years]', y = 'Drought severity [mm]', tag = 'd)') +
theme(legend.position = 'top')
p1 + p2 + p3 + p4 +
plot_layout(widths = c(1.5, 1))
ggsave('figures/trend_and_drought.png', width = 7, height = 5)
p1 <- ggplot(recFinal) +
geom_line(aes(year, Qbc, color = 'Annual')) +
labs(x = NULL, y = 'P [mm]') +
geom_line(aes(year, rolMax, colour = '50-yr max'), na.rm = TRUE, size = 0.4) +
geom_line(aes(year, rolMin, colour = '50-yr min'), na.rm = TRUE, size = 0.4) +
geom_line(aes(year, rolMed, colour = '50-yr median'), na.rm = TRUE, size = 0.4) +
geom_smooth(aes(year, rolMax, colour = '50-yr max'), size = 0.6,
formula = 'y ~ x', method = 'lm', na.rm = TRUE, fill = NA) +
geom_smooth(aes(year, rolMin, colour = '50-yr min'), size = 0.6,
formula = 'y ~ x', method = 'lm', na.rm = TRUE, fill = NA) +
geom_smooth(aes(year, rolMed, colour = '50-yr median'), size= 0.6,
formula = 'y ~ x', method = 'lm', na.rm = TRUE, fill = NA) +
scale_x_continuous(
expand = c(0, 0),
minor_breaks = seq(1500, 2025, 25),
limits = c(1500, 2025),
guide = guide_prism_offset_minor()) +
scale_y_continuous(
minor_breaks = seq(200, 900, 50),
breaks = seq(200, 900, 100),
limits = c(200, 900),
labels = skip_label(2),
guide = guide_prism_offset_minor()) +
labs(x = NULL, y = 'Precipitation [mm]', colour = NULL, tag = 'a)') +
scale_color_manual(values = c(RColorBrewer::brewer.pal(3, 'Set2'), 'gray')) +
theme(
legend.key.width = unit(0.5, 'cm'),
legend.position = 'top')
p2 <- ggplot(densCals) +
geom_ribbon(aes(x, ymin = period, ymax = y + period, group = factor(period),
fill = factor(period)),
alpha = 0.5) +
geom_line(aes(x, y + period, group = factor(period))) +
geom_linerange(aes(x, ymin = period, ymax = period + y), medians, colour = 'firebrick') +
scale_fill_manual(
labels = c('1517-1717', '1718-2018'),
values = wesanderson::wes_palette('Royal1', 4)[c(1, 4)]) +
scale_x_continuous(
guide = guide_prism_offset_minor(),
breaks = seq(200, 900, 100),
minor_breaks = seq(200, 900, 20)) +
scale_y_continuous(
expand = c(0, 0),
breaks = c(1.5, 2.5),
labels = c('1517-1717', '            1718-2018')) +
labs(x = 'Precipitation [mm]', y = NULL, tag = 'b)') +
theme(
legend.position = 'none',
axis.line.y = element_blank(),
axis.text.y.left = element_text(angle = 90, hjust = 0.5),
axis.ticks.y = element_blank())
p3 <- ggplot(recFinal) +
geom_rect(
aes(xmin = yearStart, xmax = yearFinal, ymin = -Inf, ymax = Inf),
worstDroughts,
fill = 'magenta4', alpha = 0.1) +
geom_col(aes(year, dP, fill = dP)) +
scale_fill_distiller(
palette = 'BrBG', limits = abs_range(recFinal$dP),
guide = guide_none(),
direction = 1) +
scale_color_manual(values = 'black') +
scale_x_continuous(
expand = c(0, 0),
minor_breaks = seq(1500, 2025, 25),
limits = c(1500, 2025),
guide = guide_prism_offset_minor()) +
scale_y_continuous(
breaks = seq(-300, 400, 100),
minor_breaks = seq(-300, 400, 50),
guide = guide_prism_offset_minor()) +
labs(x = NULL, y = 'Precipitation anomaly [mm]', tag = 'c)') +
theme(
legend.position = 'top')
p4 <- ggplot(droughts) +
geom_point(aes(dur, peak, color = as.character(period)), alpha = 0.6) +
geom_text(
aes(dur, peak, label = paste(yearStart, yearFinal, sep = '-')),
worstDroughts,
size = 2, hjust = 0.8, nudge_y = -15) +
# scale_x_continuous(
#   breaks = seq(2, 20, 2),
#   guide = guide_prism_offset_minor()) +
# scale_y_continuous(
#   breaks = seq(-300, 0, 50),
#   limits = c(-275, -25),
#   guide = guide_prism_offset_minor()) +
scale_color_manual(
labels = c('1517-1717', '1718-2018'),
values = wesanderson::wes_palette('Royal1', 4)[c(1, 4)]) +
labs(x = 'Drought duration [years]', y = 'Drought severity [mm]', tag = 'd)') +
theme(legend.position = 'top')
p1 + p2 + p3 + p4 +
plot_layout(widths = c(1.5, 1))
# ggsave('figures/trend_and_drought.png', width = 7, height = 5)
p1 <- ggplot(recFinal) +
geom_line(aes(year, Qbc, color = 'Annual')) +
labs(x = NULL, y = 'P [mm]') +
geom_line(aes(year, rolMax, colour = '50-yr max'), na.rm = TRUE, size = 0.4) +
geom_line(aes(year, rolMin, colour = '50-yr min'), na.rm = TRUE, size = 0.4) +
geom_line(aes(year, rolMed, colour = '50-yr median'), na.rm = TRUE, size = 0.4) +
geom_smooth(aes(year, rolMax, colour = '50-yr max'), size = 0.6,
formula = 'y ~ x', method = 'lm', na.rm = TRUE, fill = NA) +
geom_smooth(aes(year, rolMin, colour = '50-yr min'), size = 0.6,
formula = 'y ~ x', method = 'lm', na.rm = TRUE, fill = NA) +
geom_smooth(aes(year, rolMed, colour = '50-yr median'), size= 0.6,
formula = 'y ~ x', method = 'lm', na.rm = TRUE, fill = NA) +
scale_x_continuous(
expand = c(0, 0),
minor_breaks = seq(1500, 2025, 25),
limits = c(1500, 2025),
guide = guide_prism_offset_minor()) +
scale_y_continuous(
minor_breaks = seq(200, 900, 50),
breaks = seq(200, 900, 100),
limits = c(200, 900),
labels = skip_label(2),
guide = guide_prism_offset_minor()) +
labs(x = NULL, y = 'Precipitation [mm]', colour = NULL, tag = 'a)') +
scale_color_manual(values = c(RColorBrewer::brewer.pal(3, 'Set2'), 'gray')) +
theme(
legend.key.width = unit(0.5, 'cm'),
legend.position = 'top')
p2 <- ggplot(densCals) +
geom_ribbon(aes(x, ymin = period, ymax = y + period, group = factor(period),
fill = factor(period)),
alpha = 0.5) +
geom_line(aes(x, y + period, group = factor(period))) +
geom_linerange(aes(x, ymin = period, ymax = period + y), medians, colour = 'firebrick') +
scale_fill_manual(
labels = c('1517-1717', '1718-2018'),
values = wesanderson::wes_palette('Royal1', 4)[c(1, 4)]) +
scale_x_continuous(
guide = guide_prism_offset_minor(),
breaks = seq(200, 900, 100),
minor_breaks = seq(200, 900, 20)) +
scale_y_continuous(
expand = c(0, 0),
breaks = c(1.5, 2.5),
labels = c('1517-1717', '            1718-2018')) +
labs(x = 'Precipitation [mm]', y = NULL, tag = 'b)') +
theme(
legend.position = 'none',
axis.line.y = element_blank(),
axis.text.y.left = element_text(angle = 90, hjust = 0.5),
axis.ticks.y = element_blank())
p3 <- ggplot(recFinal) +
geom_rect(
aes(xmin = yearStart, xmax = yearFinal, ymin = -Inf, ymax = Inf),
worstDroughts,
fill = 'magenta4', alpha = 0.1) +
geom_col(aes(year, dP, fill = dP)) +
scale_fill_distiller(
palette = 'BrBG', limits = abs_range(recFinal$dP),
guide = guide_none(),
direction = 1) +
scale_color_manual(values = 'black') +
scale_x_continuous(
expand = c(0, 0),
minor_breaks = seq(1500, 2025, 25),
limits = c(1500, 2025),
guide = guide_prism_offset_minor()) +
scale_y_continuous(
breaks = seq(-300, 400, 100),
minor_breaks = seq(-300, 400, 50),
guide = guide_prism_offset_minor()) +
labs(x = NULL, y = 'Precipitation anomaly [mm]', tag = 'c)') +
theme(
legend.position = 'top')
p4 <- ggplot(droughts) +
geom_point(aes(dur, peak, color = as.character(period)), alpha = 0.6) +
geom_text(
aes(dur, peak, label = paste(yearStart, yearFinal, sep = '-')),
worstDroughts,
size = 2, hjust = 0.8, nudge_y = -15) +
# scale_x_continuous(
#   breaks = seq(2, 20, 2),
#   guide = guide_prism_offset_minor()) +
# scale_y_continuous(
#   breaks = seq(-300, 0, 50),
#   limits = c(-275, -25),
#   guide = guide_prism_offset_minor()) +
scale_color_manual(
labels = c('1517-1717', '1718-2018'),
values = wesanderson::wes_palette('Royal1', 4)[c(1, 4)]) +
labs(x = 'Drought duration [years]', y = 'Drought severity [mm]', tag = 'd)') +
theme(legend.position = 'top')
p1 + p2 + p3 + p4 +
plot_layout(widths = c(1.5, 1))
# ggsave('figures/trend_and_drought.png', width = 7, height = 5)
recFinal[, period := NULL]
setcolorder(recFinal, 'year')
fwrite(recFinal, 'results/chitral-sep-aug-precip-reconst.csv')
recFinal
fwrite(
recFinal[, .(year, P = Q, Plower = Ql, Pupper = Qu, Pbc = Qbc)],
'results/chitral-sep-aug-precip-reconst.csv')
scores <- melt(lmCV$metrics.dist[, .(R2, RE, CE)],
measure.vars = 1:3,
variable.name = 'metric')
ggplot(scores) +
geom_boxplot(aes(metric, value), fill = 'grey95') +
geom_jitter(aes(metric, value, color = metric), width = 0.25) +
scale_color_brewer(palette = 'Set2') +
scale_x_discrete(
name = NULL,
guide = guide_prism_bracket(),
labels = c('R\u00b2', 'RE', 'CE')) +
scale_y_continuous(
name = 'Metric value [-]',
limits = c(0.25, 0.85),
breaks = seq(0.2, 0.9, 0.1),
minor_breaks = seq(0.25, 0.85, 0.05),
guide = guide_prism_offset_minor()) +
theme(legend.position = 'none')
